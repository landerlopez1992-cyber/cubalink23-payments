<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pago Final - ¬øEst√°s seguro?</title>
  <style>
    body { font-family: system-ui, Arial; margin: 0; background:#f7f7fb; }
    .card { max-width: 520px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.06); padding: 22px 22px 28px; }
    h1 { font-size: 20px; margin: 0 0 18px; }
    #card-container { border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; }
    button { width: 100%; padding: 12px 14px; border:0; border-radius: 10px; cursor:pointer; margin-top: 16px; font-weight: 600; }
    .primary { background:#4f46e5; color:#fff; }
    .muted { color:#6b7280; font-size: 14px; margin-top:12px;}
    .msg { margin-top: 14px; padding: 10px; border-radius: 8px; font-size: 14px; }
    .ok { background:#ecfdf5; color:#065f46; border:1px solid #34d399; }
    .err{ background:#fef2f2; color:#991b1b; border:1px solid #fca5a5; white-space: pre-wrap;}
  </style>
  <!-- Web Payments SDK (SANDBOX) -->
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
</head>
<body>
  <div class="card">
    <h1>üîí Pago Final</h1>
    <p style="color: #6b7280; margin: 0 0 16px;">Confirma tu m√©todo de pago</p>
    
    <!-- Formulario Square -->
    <div id="card-container"></div>
    
    <!-- ‚úÖ Tarjetas guardadas DEBAJO del formulario -->
    <div id="saved-cards" style="margin-top: 20px;">
      <h3 style="font-size: 16px; margin: 0 0 12px; color: #374151;">üí≥ Tus tarjetas guardadas:</h3>
      <div id="cards-list" style="margin-bottom: 16px;"></div>
      <p id="no-cards" style="color: #6b7280; font-size: 14px; font-style: italic; display: none;">
        No tienes tarjetas guardadas. Escribe los datos arriba o agrega una tarjeta.
      </p>
    </div>
    
    <div id="out" class="muted"></div>
    <button id="pay" class="primary">üîí Confirmar Pago</button>
    <div id="msg" class="msg" style="display:none"></div>
  </div>

  <script>
    // ‚úÖ variables en scope global (evita "card is not defined")
    let payments, card;

    const appId = "sandbox-sq0idb-IsIJtKqx2OHdVJjYmg6puA";            // sandbox app id
    const locationId = "LZVTP0YQ9YQBB";  // sandbox location

    // Monto/currency desde query (?amount=1574&currency=USD&note=...)
    const params = new URLSearchParams(location.search);
    const amount = parseInt(params.get("amount") || "100", 10);
    const currency = (params.get("currency") || "USD").toUpperCase();
    const note = params.get("note") || "Test payment";
    const customerId = params.get("customer_id");
    
    // ‚úÖ Datos para pre-llenar
    let prefillNumber = params.get("prefill_number");
    let prefillExpiry = params.get("prefill_expiry");
    let prefillCvv = params.get("prefill_cvv");
    
    // ‚úÖ Cargar tarjetas REALES de Supabase usando el nuevo endpoint
    async function loadUserCards() {
      try {
        if (!customerId) {
          document.getElementById('no-cards').style.display = 'block';
          return;
        }
        
        console.log('üîÑ Cargando tarjetas para user:', customerId);
        
        // ‚úÖ Usar el nuevo endpoint /api/cards?user_id=...
        const response = await fetch(`/api/cards?user_id=${customerId}`, {
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        const cards = data.cards || [];
        console.log('üìã Tarjetas obtenidas:', cards);
        
        const cardsList = document.getElementById('cards-list');
        if (cards.length === 0) {
          document.getElementById('no-cards').style.display = 'block';
          return;
        }
        
        // ‚úÖ Mapear tarjetas reales a n√∫meros de prueba de Square
        const cardMapping = {
          'visa': '4111111111111111',
          'mastercard': '5105105105105100',
          'master': '5105105105105100'
        };
        
        cardsList.innerHTML = cards.map((card, index) => {
          const cardType = (card.brand || card.card_type || 'visa').toLowerCase();
          const testNumber = cardMapping[cardType] || '4111111111111111';
          const expiry = card.exp_month && card.exp_year ? 
            `${String(card.exp_month).padStart(2, '0')}/${String(card.exp_year).slice(-2)}` : '12/25';
          
          return `
            <div onclick="selectCard('${testNumber}', '${expiry}', '123')" 
                 style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; background: #f9fafb; transition: all 0.2s; border-left: 4px solid #3b82f6;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>üí≥ ${card.brand || card.card_type || 'Tarjeta'} ****${card.last4}</strong><br>
                  <small style="color: #6b7280;">Vence: ${expiry}</small>
                </div>
                <div style="color: #3b82f6; font-weight: bold;">Usar ‚Üí</div>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (e) {
        console.log('‚ùå Error cargando tarjetas de Supabase:', e);
        document.getElementById('no-cards').style.display = 'block';
        document.getElementById('no-cards').textContent = 'No se pudieron cargar las tarjetas. Escribe los datos manualmente.';
      }
    }
    
    function selectCard(number, expiry, cvv) {
      console.log('üéØ Tarjeta seleccionada:', {number, expiry, cvv});
      fillSquareFields(number, expiry, cvv);
    }
    
    // ‚úÖ Funci√≥n AGRESIVA para llenar campos de Square
    function fillSquareFieldsAggressively(number, expiry, cvv) {
      console.log('üöÄ LLENADO AGRESIVO:', {number, expiry, cvv});
      
      // Intentos cada 200ms por 10 segundos
      let attempts = 0;
      const maxAttempts = 50;
      
      const tryFill = () => {
        attempts++;
        console.log(`üîÑ Intento ${attempts}/${maxAttempts}`);
        
        try {
          // Buscar TODOS los inputs en toda la p√°gina
          const allInputs = document.querySelectorAll('input');
          console.log(`üìù Total inputs encontrados: ${allInputs.length}`);
          
          allInputs.forEach((input, i) => {
            const isVisible = input.offsetParent !== null;
            const hasValue = input.value.length > 0;
            
            console.log(`Input ${i}:`, {
              type: input.type,
              placeholder: input.placeholder,
              visible: isVisible,
              hasValue: hasValue,
              value: input.value
            });
            
            // Si el campo est√° visible y vac√≠o, intentar llenarlo
            if (isVisible && !hasValue) {
              // Detectar tipo de campo por placeholder, name, etc.
              const fieldType = (input.placeholder + ' ' + input.name + ' ' + input.id).toLowerCase();
              
              if (fieldType.includes('number') || fieldType.includes('card') || i === 0) {
                input.value = number;
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
                input.dispatchEvent(new Event('keyup', { bubbles: true }));
                console.log(`‚úÖ N√∫mero llenado en input ${i}`);
              } else if (fieldType.includes('expir') || fieldType.includes('mm') || fieldType.includes('yy') || i === 1) {
                input.value = expiry;
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
                input.dispatchEvent(new Event('keyup', { bubbles: true }));
                console.log(`‚úÖ Expiry llenado en input ${i}`);
              } else if (fieldType.includes('cvv') || fieldType.includes('cvc') || fieldType.includes('security') || i === 2) {
                input.value = cvv;
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
                input.dispatchEvent(new Event('keyup', { bubbles: true }));
                console.log(`‚úÖ CVV llenado en input ${i}`);
              }
            }
          });
          
          // Verificar si se llenaron los campos
          const filledInputs = Array.from(allInputs).filter(input => input.value.length > 0).length;
          if (filledInputs >= 3 || attempts >= maxAttempts) {
            console.log(`‚úÖ Auto-llenado completado. Campos llenados: ${filledInputs}`);
            return;
          }
          
        } catch (e) {
          console.log(`‚ö†Ô∏è Error en intento ${attempts}:`, e);
        }
        
        // Continuar intentando
        if (attempts < maxAttempts) {
          setTimeout(tryFill, 200);
        }
      };
      
      // Iniciar intentos despu√©s de 500ms
      setTimeout(tryFill, 500);
    }
    
    // ‚úÖ Funci√≥n simple para selecci√≥n manual
    function fillSquareFields(number, expiry, cvv) {
      fillSquareFieldsAggressively(number, expiry, cvv);
    }

    const out = document.getElementById('out');
    const msg = document.getElementById('msg');

    function show(text, ok=false) {
      msg.style.display = 'block';
      msg.className = 'msg ' + (ok ? 'ok' : 'err');
      msg.textContent = text;
    }

    (async function init() {
      try {
        payments = window.Square.payments(appId, locationId); // ‚úÖ inicializaci√≥n oficial
        
        // ‚úÖ Configuraci√≥n b√°sica sin estilos problem√°ticos
        const cardOptions = {
          style: {
            input: {
              fontSize: '16px',
              fontFamily: 'Arial, sans-serif' // ‚úÖ Fuente compatible
            }
          }
        };
        
        card = await payments.card(cardOptions);
        await card.attach('#card-container');
        out.textContent = `Monto: $${(amount / 100).toFixed(2)} ${currency}`; // ‚úÖ Convertir centavos a d√≥lares
        
        // ‚úÖ Auto-llenar inmediatamente si hay datos
        if (prefillNumber) {
          console.log('üéØ FORZANDO auto-llenado inmediato');
          fillSquareFieldsAggressively(prefillNumber, prefillExpiry, prefillCvv);
        }
        
        // ‚úÖ Cargar tarjetas guardadas
        await loadUserCards();
        
        // ‚úÖ AUTO-LLENAR campos de Square despu√©s de que se cargue
        if (prefillNumber || prefillExpiry || prefillCvv) {
          console.log('üîÑ Iniciando auto-llenado:', {number: prefillNumber, expiry: prefillExpiry, cvv: prefillCvv});
          
          // Funci√≥n para auto-llenar con m√∫ltiples estrategias
          const autoFill = () => {
            try {
              // Estrategia 1: Buscar en DOM principal
              const cardContainer = document.getElementById('card-container');
              const allInputs = cardContainer ? cardContainer.querySelectorAll('input') : document.querySelectorAll('input');
              console.log('üîç Inputs en card-container:', allInputs.length);
              
              allInputs.forEach((input, index) => {
                console.log(`Input ${index}:`, {
                  type: input.type,
                  placeholder: input.placeholder,
                  name: input.name,
                  id: input.id,
                  className: input.className
                });
              });
              
              // Estrategia 2: Usar MutationObserver para detectar iframes
              const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                  mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                      // Buscar iframes de Square
                      const iframes = node.querySelectorAll ? node.querySelectorAll('iframe') : [];
                      iframes.forEach((iframe, i) => {
                        console.log(`üîç Iframe ${i} encontrado:`, iframe.src);
                        
                        // Intentar acceder al contenido del iframe (si es same-origin)
                        try {
                          setTimeout(() => {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                            if (iframeDoc) {
                              const iframeInputs = iframeDoc.querySelectorAll('input');
                              console.log(`üìù Inputs en iframe ${i}:`, iframeInputs.length);
                              
                              iframeInputs.forEach((input, j) => {
                                console.log(`Iframe ${i} Input ${j}:`, {
                                  type: input.type,
                                  placeholder: input.placeholder,
                                  value: input.value
                                });
                                
                                // Intentar llenar seg√∫n el tipo
                                if (input.type === 'tel' || input.placeholder?.includes('number') || j === 0) {
                                  if (prefillNumber && !input.value) {
                                    input.value = prefillNumber;
                                    input.dispatchEvent(new Event('input', { bubbles: true }));
                                    input.dispatchEvent(new Event('change', { bubbles: true }));
                                    console.log('‚úÖ N√∫mero auto-llenado en iframe');
                                  }
                                } else if (input.placeholder?.includes('MM') || input.placeholder?.includes('YY') || j === 1) {
                                  if (prefillExpiry && !input.value) {
                                    input.value = prefillExpiry;
                                    input.dispatchEvent(new Event('input', { bubbles: true }));
                                    input.dispatchEvent(new Event('change', { bubbles: true }));
                                    console.log('‚úÖ Expiry auto-llenado en iframe');
                                  }
                                } else if (input.placeholder?.includes('CVV') || input.placeholder?.includes('CVC') || j === 2) {
                                  if (prefillCvv && !input.value) {
                                    input.value = prefillCvv;
                                    input.dispatchEvent(new Event('input', { bubbles: true }));
                                    input.dispatchEvent(new Event('change', { bubbles: true }));
                                    console.log('‚úÖ CVV auto-llenado en iframe');
                                  }
                                }
                              });
                            }
                          }, 500);
                        } catch (e) {
                          console.log('‚ö†Ô∏è No se puede acceder al iframe (cross-origin):', e.message);
                        }
                      });
                    }
                  });
                });
              });
              
              observer.observe(cardContainer || document.body, {
                childList: true,
                subtree: true
              });
              
              // Detener observer despu√©s de 10 segundos
              setTimeout(() => observer.disconnect(), 10000);
              
            } catch (e) {
              console.log('‚ö†Ô∏è Error en auto-fill:', e);
            }
          };
          
          // Ejecutar auto-fill con m√∫ltiples delays
          setTimeout(autoFill, 1000);
          setTimeout(autoFill, 2000);
          setTimeout(autoFill, 3000);
        }
      } catch (e) {
        show('Error inicializando Square: ' + (e.message || e), false);
      }
    })();

    async function tokenize() {
      const result = await card.tokenize();
      if (result.status === 'OK') return result.token;
      // Muestra detalle de errores del SDK
      const details = (result.errors || []).map(e => `${e.code}: ${e.message}`).join('\n');
      throw new Error(details || 'Tokenization failed');
    }

    document.getElementById('pay').addEventListener('click', async () => {
      msg.style.display = 'none';
      try {
        const nonce = await tokenize();

        // ‚úÖ NUEVO: Crear tarjeta EN Square y guardar metadata en Supabase
        if (customerId) {
          try {
            console.log('üíæ Guardando nueva tarjeta para customer:', customerId);
            const createRes = await fetch('/api/cards/create', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({
                user_id: customerId,
                customer_id: customerId, // Asumimos que customer_id = user_id por ahora
                nonce: nonce,
                postal_code: '12345',
                name: 'Usuario'
              })
            });
            
            if (createRes.ok) {
              const cardData = await createRes.json();
              console.log('‚úÖ Tarjeta creada y guardada:', cardData);
            } else {
              console.log('‚ö†Ô∏è No se pudo guardar la tarjeta, pero continuando con pago');
            }
          } catch (e) {
            console.log('‚ö†Ô∏è Error guardando tarjeta:', e);
          }
        }

        // ‚úÖ Llama a tu backend Flask en Render
        const res = await fetch('/api/payments', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            source_id: nonce,
            amount_cents: amount,
            currency: currency,
            note: note,
            customer_id: customerId
          })
        });

        const data = await res.json();
        
        // ‚úÖ Manejar TANTO √©xito como error de Square
        let payment, status, result;
        
        if (res.ok && data.payment) {
          // Pago exitoso
          payment = data.payment;
          status = payment.status || 'COMPLETED';
          result = {
            status: status,
            success: status === 'COMPLETED',
            payment_id: payment.id,
            receipt_url: payment.receipt_url,
            amount: payment.amount_money?.amount,
            last4: payment.card_details?.card?.last_4,
            message: 'Pago procesado exitosamente'
          };
        } else {
          // Error de Square (declined, etc.)
          let errorData = data;
          try {
            // Intentar parsear message si es string JSON
            if (data.message && typeof data.message === 'string') {
              errorData = JSON.parse(data.message);
            }
          } catch (e) {
            // Si no es JSON v√°lido, usar data original
            errorData = data;
          }
          
          payment = errorData.payment;
          status = payment?.status || 'FAILED';
          result = {
            status: 'FAILED',
            success: false,
            payment_id: payment?.id,
            amount: payment?.amount_money?.amount,
            last4: payment?.card_details?.card?.last_4,
            message: data.code === 'GENERIC_DECLINE' ? 'Tarjeta declinada' : 'Pago fallido',
            error_code: data.code
          };
        }

        // ‚úÖ SIEMPRE enviar a Flutter (√©xito Y error)
        if (window.ReactNativeWebView?.postMessage) {
          window.ReactNativeWebView.postMessage(JSON.stringify({type:'payment_result', data: result}));
        } else if (window.webkit?.messageHandlers?.ReactNativeWebView) {
          window.webkit.messageHandlers.ReactNativeWebView.postMessage(JSON.stringify({type:'payment_result', data: result}));
        } else {
          // Fallback - mostrar en WebView
          show(`Pago ${status}\n\nID: ${payment?.id || 'N/A'}\nMonto: $${(result.amount || 0) / 100}`, result.success);
        }
      } catch (err) {
        show(String(err), false);
      }
    });
  </script>
</body>
</html>