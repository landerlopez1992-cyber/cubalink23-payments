<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pago Final - ¿Estás seguro?</title>
  <style>
    body { font-family: system-ui, Arial; margin: 0; background:#f7f7fb; }
    .card { max-width: 520px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.06); padding: 22px 22px 28px; }
    h1 { font-size: 20px; margin: 0 0 18px; }
    #card-container { border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; }
    button { width: 100%; padding: 12px 14px; border:0; border-radius: 10px; cursor:pointer; margin-top: 16px; font-weight: 600; }
    .primary { background:#4f46e5; color:#fff; }
    .muted { color:#6b7280; font-size: 14px; margin-top:12px;}
    .msg { margin-top: 14px; padding: 10px; border-radius: 8px; font-size: 14px; }
    .ok { background:#ecfdf5; color:#065f46; border:1px solid #34d399; }
    .err{ background:#fef2f2; color:#991b1b; border:1px solid #fca5a5; white-space: pre-wrap;}
  </style>
  <!-- Web Payments SDK (SANDBOX) -->
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
</head>
<body>
  <div class="card">
    <h1>🔒 Pago Final</h1>
    <p style="color: #6b7280; margin: 0 0 16px;">Confirma tu método de pago</p>
    <div id="card-container"></div>
    <button id="pay" class="primary">🔒 Confirmar Pago</button>
    <div id="out" class="muted"></div>
    <div id="msg" class="msg" style="display:none"></div>
  </div>

  <!-- ✅ Cortina de selección de tarjetas -->
  <div id="card-selector" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: white; border-radius: 16px 16px 0 0; padding: 20px; max-height: 70vh; overflow-y: auto;">
      <h3 style="margin: 0 0 16px; text-align: center;">💳 Selecciona tu tarjeta</h3>
      <div id="cards-list"></div>
      <button onclick="closeCardSelector()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #f5f5f5; margin-top: 16px;">
        Cancelar
      </button>
    </div>
  </div>

  <script>
    // ✅ variables en scope global (evita "card is not defined")
    let payments, card;

    const appId = "sandbox-sq0idb-IsIJtKqx2OHdVJjYmg6puA";            // sandbox app id
    const locationId = "LZVTP0YQ9YQBB";  // sandbox location

    // Monto/currency desde query (?amount=1574&currency=USD&note=...)
    const params = new URLSearchParams(location.search);
    const amount = parseInt(params.get("amount") || "100", 10);
    const currency = (params.get("currency") || "USD").toUpperCase();
    const note = params.get("note") || "Test payment";
    const customerId = params.get("customer_id");
    
    // ✅ Datos para pre-llenar
    let prefillNumber = params.get("prefill_number");
    let prefillExpiry = params.get("prefill_expiry");
    let prefillCvv = params.get("prefill_cvv");
    
    // ✅ Funciones para cortina de selección
    function showCardSelector() {
      document.getElementById('card-selector').style.display = 'block';
      loadUserCards();
    }
    
    function closeCardSelector() {
      document.getElementById('card-selector').style.display = 'none';
    }
    
    async function loadUserCards() {
      try {
        const response = await fetch(`/api/cards/list?customer_id=${customerId}`);
        const data = await response.json();
        const cards = data.cards || [];
        
        const cardsList = document.getElementById('cards-list');
        cardsList.innerHTML = cards.map(card => `
          <div onclick="selectCard('${card.number}', '${card.expiry}', '${card.cvv}')" 
               style="padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; cursor: pointer; background: #f9f9f9;">
            <strong>${card.type || 'Tarjeta'} ****${card.last4}</strong><br>
            <small>Vence: ${card.expiry}</small>
          </div>
        `).join('');
      } catch (e) {
        console.log('Error cargando tarjetas:', e);
      }
    }
    
    function selectCard(number, expiry, cvv) {
      prefillNumber = number;
      prefillExpiry = expiry;
      prefillCvv = cvv;
      closeCardSelector();
      fillSquareFields();
    }

    const out = document.getElementById('out');
    const msg = document.getElementById('msg');

    function show(text, ok=false) {
      msg.style.display = 'block';
      msg.className = 'msg ' + (ok ? 'ok' : 'err');
      msg.textContent = text;
    }

    (async function init() {
      try {
        payments = window.Square.payments(appId, locationId); // ✅ inicialización oficial
        
        // ✅ Configuración básica sin estilos problemáticos
        const cardOptions = {
          style: {
            input: {
              fontSize: '16px',
              fontFamily: 'Arial, sans-serif' // ✅ Fuente compatible
            }
          }
        };
        
        card = await payments.card(cardOptions);
        await card.attach('#card-container');
        out.textContent = `Monto: $${(amount / 100).toFixed(2)} ${currency}`; // ✅ Convertir centavos a dólares
        
        // ✅ Detectar click en campo de número para mostrar cortina
        setTimeout(() => {
          const cardContainer = document.getElementById('card-container');
          const cardNumberField = cardContainer.querySelector('iframe');
          
          if (cardNumberField) {
            // Agregar overlay invisible para detectar clicks
            const overlay = document.createElement('div');
            overlay.style.cssText = `
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 40px;
              background: transparent;
              cursor: pointer;
              z-index: 10;
            `;
            
            overlay.onclick = () => {
              console.log('🎯 Click en campo de tarjeta - abriendo selector');
              showCardSelector();
            };
            
            cardContainer.style.position = 'relative';
            cardContainer.appendChild(overlay);
          }
        }, 1500);
        
        // ✅ AUTO-LLENAR campos de Square después de que se cargue
        if (prefillNumber || prefillExpiry || prefillCvv) {
          console.log('🔄 Iniciando auto-llenado:', {number: prefillNumber, expiry: prefillExpiry, cvv: prefillCvv});
          
          // Función para auto-llenar con múltiples estrategias
          const autoFill = () => {
            try {
              // Estrategia 1: Buscar en DOM principal
              const cardContainer = document.getElementById('card-container');
              const allInputs = cardContainer ? cardContainer.querySelectorAll('input') : document.querySelectorAll('input');
              console.log('🔍 Inputs en card-container:', allInputs.length);
              
              allInputs.forEach((input, index) => {
                console.log(`Input ${index}:`, {
                  type: input.type,
                  placeholder: input.placeholder,
                  name: input.name,
                  id: input.id,
                  className: input.className
                });
              });
              
              // Estrategia 2: Usar MutationObserver para detectar iframes
              const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                  mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                      // Buscar iframes de Square
                      const iframes = node.querySelectorAll ? node.querySelectorAll('iframe') : [];
                      iframes.forEach((iframe, i) => {
                        console.log(`🔍 Iframe ${i} encontrado:`, iframe.src);
                        
                        // Intentar acceder al contenido del iframe (si es same-origin)
                        try {
                          setTimeout(() => {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                            if (iframeDoc) {
                              const iframeInputs = iframeDoc.querySelectorAll('input');
                              console.log(`📝 Inputs en iframe ${i}:`, iframeInputs.length);
                              
                              iframeInputs.forEach((input, j) => {
                                console.log(`Iframe ${i} Input ${j}:`, {
                                  type: input.type,
                                  placeholder: input.placeholder,
                                  value: input.value
                                });
                                
                                // Intentar llenar según el tipo
                                if (input.type === 'tel' || input.placeholder?.includes('number') || j === 0) {
                                  if (prefillNumber && !input.value) {
                                    input.value = prefillNumber;
                                    input.dispatchEvent(new Event('input', { bubbles: true }));
                                    input.dispatchEvent(new Event('change', { bubbles: true }));
                                    console.log('✅ Número auto-llenado en iframe');
                                  }
                                } else if (input.placeholder?.includes('MM') || input.placeholder?.includes('YY') || j === 1) {
                                  if (prefillExpiry && !input.value) {
                                    input.value = prefillExpiry;
                                    input.dispatchEvent(new Event('input', { bubbles: true }));
                                    input.dispatchEvent(new Event('change', { bubbles: true }));
                                    console.log('✅ Expiry auto-llenado en iframe');
                                  }
                                } else if (input.placeholder?.includes('CVV') || input.placeholder?.includes('CVC') || j === 2) {
                                  if (prefillCvv && !input.value) {
                                    input.value = prefillCvv;
                                    input.dispatchEvent(new Event('input', { bubbles: true }));
                                    input.dispatchEvent(new Event('change', { bubbles: true }));
                                    console.log('✅ CVV auto-llenado en iframe');
                                  }
                                }
                              });
                            }
                          }, 500);
                        } catch (e) {
                          console.log('⚠️ No se puede acceder al iframe (cross-origin):', e.message);
                        }
                      });
                    }
                  });
                });
              });
              
              observer.observe(cardContainer || document.body, {
                childList: true,
                subtree: true
              });
              
              // Detener observer después de 10 segundos
              setTimeout(() => observer.disconnect(), 10000);
              
            } catch (e) {
              console.log('⚠️ Error en auto-fill:', e);
            }
          };
          
          // Ejecutar auto-fill con múltiples delays
          setTimeout(autoFill, 1000);
          setTimeout(autoFill, 2000);
          setTimeout(autoFill, 3000);
        }
      } catch (e) {
        show('Error inicializando Square: ' + (e.message || e), false);
      }
    })();

    async function tokenize() {
      const result = await card.tokenize();
      if (result.status === 'OK') return result.token;
      // Muestra detalle de errores del SDK
      const details = (result.errors || []).map(e => `${e.code}: ${e.message}`).join('\n');
      throw new Error(details || 'Tokenization failed');
    }

    document.getElementById('pay').addEventListener('click', async () => {
      msg.style.display = 'none';
      try {
        const nonce = await tokenize();

        // ✅ Llama a tu backend Flask en Render
        const res = await fetch('/api/payments', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            source_id: nonce,
            amount_cents: amount,
            currency: currency,
            note: note
          })
        });

        const data = await res.json();
        
        // ✅ Manejar TANTO éxito como error de Square
        let payment, status, result;
        
        if (res.ok && data.payment) {
          // Pago exitoso
          payment = data.payment;
          status = payment.status || 'COMPLETED';
          result = {
            status: status,
            success: status === 'COMPLETED',
            payment_id: payment.id,
            receipt_url: payment.receipt_url,
            amount: payment.amount_money?.amount,
            last4: payment.card_details?.card?.last_4,
            message: 'Pago procesado exitosamente'
          };
        } else {
          // Error de Square (declined, etc.)
          let errorData = data;
          try {
            // Intentar parsear message si es string JSON
            if (data.message && typeof data.message === 'string') {
              errorData = JSON.parse(data.message);
            }
          } catch (e) {
            // Si no es JSON válido, usar data original
            errorData = data;
          }
          
          payment = errorData.payment;
          status = payment?.status || 'FAILED';
          result = {
            status: 'FAILED',
            success: false,
            payment_id: payment?.id,
            amount: payment?.amount_money?.amount,
            last4: payment?.card_details?.card?.last_4,
            message: data.code === 'GENERIC_DECLINE' ? 'Tarjeta declinada' : 'Pago fallido',
            error_code: data.code
          };
        }

        // ✅ SIEMPRE enviar a Flutter (éxito Y error)
        if (window.ReactNativeWebView?.postMessage) {
          window.ReactNativeWebView.postMessage(JSON.stringify({type:'payment_result', data: result}));
        } else if (window.webkit?.messageHandlers?.ReactNativeWebView) {
          window.webkit.messageHandlers.ReactNativeWebView.postMessage(JSON.stringify({type:'payment_result', data: result}));
        } else {
          // Fallback - mostrar en WebView
          show(`Pago ${status}\n\nID: ${payment?.id || 'N/A'}\nMonto: $${(result.amount || 0) / 100}`, result.success);
        }
      } catch (err) {
        show(String(err), false);
      }
    });
  </script>
</body>
</html>