<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pago Final - Â¿EstÃ¡s seguro?</title>
  <style>
    body { font-family: system-ui, Arial; margin: 0; background:#f7f7fb; }
    .card { max-width: 520px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.06); padding: 22px 22px 28px; }
    h1 { font-size: 20px; margin: 0 0 18px; }
    #card-container { border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; }
    button { width: 100%; padding: 12px 14px; border:0; border-radius: 10px; cursor:pointer; margin-top: 16px; font-weight: 600; }
    .primary { background:#4f46e5; color:#fff; }
    .muted { color:#6b7280; font-size: 14px; margin-top:12px;}
    .msg { margin-top: 14px; padding: 10px; border-radius: 8px; font-size: 14px; }
    .ok { background:#ecfdf5; color:#065f46; border:1px solid #34d399; }
    .err{ background:#fef2f2; color:#991b1b; border:1px solid #fca5a5; white-space: pre-wrap;}
  </style>
  <!-- Web Payments SDK (SANDBOX) -->
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
</head>
<body>
  <div class="card">
    <h1>ðŸ”’ Pago Final</h1>
    <p style="color: #6b7280; margin: 0 0 16px;">Confirma tu mÃ©todo de pago</p>
    
    <!-- Formulario Square -->
    <div id="card-container"></div>
    
    <!-- âœ… Tarjetas guardadas DEBAJO del formulario -->
    <div id="saved-cards" style="margin-top: 20px;">
      <h3 style="font-size: 16px; margin: 0 0 12px; color: #374151;">ðŸ’³ Tus tarjetas guardadas:</h3>
      <div id="cards-list" style="margin-bottom: 16px;"></div>
      <p id="no-cards" style="color: #6b7280; font-size: 14px; font-style: italic; display: none;">
        No tienes tarjetas guardadas. Escribe los datos arriba o agrega una tarjeta.
      </p>
    </div>
    
    <div id="out" class="muted"></div>
    <button id="pay" class="primary">ðŸ”’ Confirmar Pago</button>
    <div id="msg" class="msg" style="display:none"></div>
  </div>

  <script>
    // âœ… variables en scope global (evita "card is not defined")
    let payments, card;

    const appId = "sandbox-sq0idb-IsIJtKqx2OHdVJjYmg6puA";            // sandbox app id
    const locationId = "LZVTP0YQ9YQBB";  // sandbox location

    // Monto/currency desde query (?amount=1574&currency=USD&note=...)
    const params = new URLSearchParams(location.search);
    const amount = parseInt(params.get("amount") || "100", 10);
    const currency = (params.get("currency") || "USD").toUpperCase();
    const note = params.get("note") || "Test payment";
    const customerId = params.get("customer_id");
    
    // âœ… Datos para pre-llenar
    let prefillNumber = params.get("prefill_number");
    let prefillExpiry = params.get("prefill_expiry");
    let prefillCvv = params.get("prefill_cvv");
    
    // âœ… Cargar tarjetas REALES de Supabase
    async function loadUserCards() {
      try {
        if (!customerId) {
          document.getElementById('no-cards').style.display = 'block';
          return;
        }
        
        console.log('ðŸ”„ Cargando tarjetas de Supabase para user:', customerId);
        
        // âœ… Llamar al backend para obtener tarjetas reales de Supabase
        const response = await fetch(`https://cubalink23-backend.onrender.com/admin/api/users/${customerId}/cards`, {
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        const cards = data.cards || data || [];
        console.log('ðŸ“‹ Tarjetas obtenidas:', cards);
        
        const cardsList = document.getElementById('cards-list');
        if (cards.length === 0) {
          document.getElementById('no-cards').style.display = 'block';
          return;
        }
        
        // âœ… Mapear tarjetas reales a nÃºmeros de prueba de Square
        const cardMapping = {
          'visa': '4111111111111111',
          'mastercard': '5105105105105100',
          'master': '5105105105105100'
        };
        
        cardsList.innerHTML = cards.map((card, index) => {
          const cardType = (card.card_type || card.type || 'visa').toLowerCase();
          const testNumber = cardMapping[cardType] || '4111111111111111';
          const expiry = card.expiry_month && card.expiry_year ? 
            `${card.expiry_month.padStart(2, '0')}/${card.expiry_year.slice(-2)}` : '12/25';
          
          return `
            <div onclick="selectCard('${testNumber}', '${expiry}', '123')" 
                 style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; cursor: pointer; background: #f9fafb; transition: all 0.2s; border-left: 4px solid #3b82f6;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>ðŸ’³ ${card.card_type || card.type || 'Tarjeta'} ****${card.last_4 || card.last4}</strong><br>
                  <small style="color: #6b7280;">Vence: ${expiry}</small>
                </div>
                <div style="color: #3b82f6; font-weight: bold;">Usar â†’</div>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (e) {
        console.log('âŒ Error cargando tarjetas de Supabase:', e);
        document.getElementById('no-cards').style.display = 'block';
        document.getElementById('no-cards').textContent = 'No se pudieron cargar las tarjetas. Escribe los datos manualmente.';
      }
    }
    
    function selectCard(number, expiry, cvv) {
      console.log('ðŸŽ¯ Tarjeta seleccionada:', {number, expiry, cvv});
      fillSquareFields(number, expiry, cvv);
    }
    
    // âœ… FunciÃ³n para llenar campos de Square
    function fillSquareFields(number, expiry, cvv) {
      console.log('ðŸ”„ Llenando campos Square:', {number, expiry, cvv});
      
      // MÃºltiples intentos para llenar campos
      const attempts = [100, 500, 1000, 2000];
      attempts.forEach(delay => {
        setTimeout(() => {
          try {
            const cardContainer = document.getElementById('card-container');
            const iframes = cardContainer.querySelectorAll('iframe');
            
            iframes.forEach((iframe, i) => {
              try {
                // Intentar diferentes mÃ©todos para acceder al iframe
                const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                if (iframeDoc) {
                  const inputs = iframeDoc.querySelectorAll('input');
                  console.log(`ðŸ“ Iframe ${i} - inputs encontrados:`, inputs.length);
                  
                  inputs.forEach((input, j) => {
                    // Llenar segÃºn posiciÃ³n (0=nÃºmero, 1=expiry, 2=cvv)
                    if (j === 0 && number) {
                      input.value = number;
                      input.dispatchEvent(new Event('input', { bubbles: true }));
                      console.log('âœ… NÃºmero llenado');
                    } else if (j === 1 && expiry) {
                      input.value = expiry;
                      input.dispatchEvent(new Event('input', { bubbles: true }));
                      console.log('âœ… Expiry llenado');
                    } else if (j === 2 && cvv) {
                      input.value = cvv;
                      input.dispatchEvent(new Event('input', { bubbles: true }));
                      console.log('âœ… CVV llenado');
                    }
                  });
                }
              } catch (e) {
                console.log(`âš ï¸ No se puede acceder al iframe ${i}:`, e.message);
              }
            });
          } catch (e) {
            console.log('âš ï¸ Error llenando campos (intento ' + delay + 'ms):', e);
          }
        }, delay);
      });
    }

    const out = document.getElementById('out');
    const msg = document.getElementById('msg');

    function show(text, ok=false) {
      msg.style.display = 'block';
      msg.className = 'msg ' + (ok ? 'ok' : 'err');
      msg.textContent = text;
    }

    (async function init() {
      try {
        payments = window.Square.payments(appId, locationId); // âœ… inicializaciÃ³n oficial
        
        // âœ… ConfiguraciÃ³n bÃ¡sica sin estilos problemÃ¡ticos
        const cardOptions = {
          style: {
            input: {
              fontSize: '16px',
              fontFamily: 'Arial, sans-serif' // âœ… Fuente compatible
            }
          }
        };
        
        card = await payments.card(cardOptions);
        await card.attach('#card-container');
        out.textContent = `Monto: $${(amount / 100).toFixed(2)} ${currency}`; // âœ… Convertir centavos a dÃ³lares
        
        // âœ… Cargar tarjetas guardadas automÃ¡ticamente
        await loadUserCards();
        
        // âœ… AUTO-LLENAR campos de Square despuÃ©s de que se cargue
        if (prefillNumber || prefillExpiry || prefillCvv) {
          console.log('ðŸ”„ Iniciando auto-llenado:', {number: prefillNumber, expiry: prefillExpiry, cvv: prefillCvv});
          
          // FunciÃ³n para auto-llenar con mÃºltiples estrategias
          const autoFill = () => {
            try {
              // Estrategia 1: Buscar en DOM principal
              const cardContainer = document.getElementById('card-container');
              const allInputs = cardContainer ? cardContainer.querySelectorAll('input') : document.querySelectorAll('input');
              console.log('ðŸ” Inputs en card-container:', allInputs.length);
              
              allInputs.forEach((input, index) => {
                console.log(`Input ${index}:`, {
                  type: input.type,
                  placeholder: input.placeholder,
                  name: input.name,
                  id: input.id,
                  className: input.className
                });
              });
              
              // Estrategia 2: Usar MutationObserver para detectar iframes
              const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                  mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                      // Buscar iframes de Square
                      const iframes = node.querySelectorAll ? node.querySelectorAll('iframe') : [];
                      iframes.forEach((iframe, i) => {
                        console.log(`ðŸ” Iframe ${i} encontrado:`, iframe.src);
                        
                        // Intentar acceder al contenido del iframe (si es same-origin)
                        try {
                          setTimeout(() => {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                            if (iframeDoc) {
                              const iframeInputs = iframeDoc.querySelectorAll('input');
                              console.log(`ðŸ“ Inputs en iframe ${i}:`, iframeInputs.length);
                              
                              iframeInputs.forEach((input, j) => {
                                console.log(`Iframe ${i} Input ${j}:`, {
                                  type: input.type,
                                  placeholder: input.placeholder,
                                  value: input.value
                                });
                                
                                // Intentar llenar segÃºn el tipo
                                if (input.type === 'tel' || input.placeholder?.includes('number') || j === 0) {
                                  if (prefillNumber && !input.value) {
                                    input.value = prefillNumber;
                                    input.dispatchEvent(new Event('input', { bubbles: true }));
                                    input.dispatchEvent(new Event('change', { bubbles: true }));
                                    console.log('âœ… NÃºmero auto-llenado en iframe');
                                  }
                                } else if (input.placeholder?.includes('MM') || input.placeholder?.includes('YY') || j === 1) {
                                  if (prefillExpiry && !input.value) {
                                    input.value = prefillExpiry;
                                    input.dispatchEvent(new Event('input', { bubbles: true }));
                                    input.dispatchEvent(new Event('change', { bubbles: true }));
                                    console.log('âœ… Expiry auto-llenado en iframe');
                                  }
                                } else if (input.placeholder?.includes('CVV') || input.placeholder?.includes('CVC') || j === 2) {
                                  if (prefillCvv && !input.value) {
                                    input.value = prefillCvv;
                                    input.dispatchEvent(new Event('input', { bubbles: true }));
                                    input.dispatchEvent(new Event('change', { bubbles: true }));
                                    console.log('âœ… CVV auto-llenado en iframe');
                                  }
                                }
                              });
                            }
                          }, 500);
                        } catch (e) {
                          console.log('âš ï¸ No se puede acceder al iframe (cross-origin):', e.message);
                        }
                      });
                    }
                  });
                });
              });
              
              observer.observe(cardContainer || document.body, {
                childList: true,
                subtree: true
              });
              
              // Detener observer despuÃ©s de 10 segundos
              setTimeout(() => observer.disconnect(), 10000);
              
            } catch (e) {
              console.log('âš ï¸ Error en auto-fill:', e);
            }
          };
          
          // Ejecutar auto-fill con mÃºltiples delays
          setTimeout(autoFill, 1000);
          setTimeout(autoFill, 2000);
          setTimeout(autoFill, 3000);
        }
      } catch (e) {
        show('Error inicializando Square: ' + (e.message || e), false);
      }
    })();

    async function tokenize() {
      const result = await card.tokenize();
      if (result.status === 'OK') return result.token;
      // Muestra detalle de errores del SDK
      const details = (result.errors || []).map(e => `${e.code}: ${e.message}`).join('\n');
      throw new Error(details || 'Tokenization failed');
    }

    document.getElementById('pay').addEventListener('click', async () => {
      msg.style.display = 'none';
      try {
        const nonce = await tokenize();

        // âœ… Llama a tu backend Flask en Render
        const res = await fetch('/api/payments', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            source_id: nonce,
            amount_cents: amount,
            currency: currency,
            note: note
          })
        });

        const data = await res.json();
        
        // âœ… Manejar TANTO Ã©xito como error de Square
        let payment, status, result;
        
        if (res.ok && data.payment) {
          // Pago exitoso
          payment = data.payment;
          status = payment.status || 'COMPLETED';
          result = {
            status: status,
            success: status === 'COMPLETED',
            payment_id: payment.id,
            receipt_url: payment.receipt_url,
            amount: payment.amount_money?.amount,
            last4: payment.card_details?.card?.last_4,
            message: 'Pago procesado exitosamente'
          };
        } else {
          // Error de Square (declined, etc.)
          let errorData = data;
          try {
            // Intentar parsear message si es string JSON
            if (data.message && typeof data.message === 'string') {
              errorData = JSON.parse(data.message);
            }
          } catch (e) {
            // Si no es JSON vÃ¡lido, usar data original
            errorData = data;
          }
          
          payment = errorData.payment;
          status = payment?.status || 'FAILED';
          result = {
            status: 'FAILED',
            success: false,
            payment_id: payment?.id,
            amount: payment?.amount_money?.amount,
            last4: payment?.card_details?.card?.last_4,
            message: data.code === 'GENERIC_DECLINE' ? 'Tarjeta declinada' : 'Pago fallido',
            error_code: data.code
          };
        }

        // âœ… SIEMPRE enviar a Flutter (Ã©xito Y error)
        if (window.ReactNativeWebView?.postMessage) {
          window.ReactNativeWebView.postMessage(JSON.stringify({type:'payment_result', data: result}));
        } else if (window.webkit?.messageHandlers?.ReactNativeWebView) {
          window.webkit.messageHandlers.ReactNativeWebView.postMessage(JSON.stringify({type:'payment_result', data: result}));
        } else {
          // Fallback - mostrar en WebView
          show(`Pago ${status}\n\nID: ${payment?.id || 'N/A'}\nMonto: $${(result.amount || 0) / 100}`, result.success);
        }
      } catch (err) {
        show(String(err), false);
      }
    });
  </script>
</body>
</html>