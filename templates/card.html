<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Datos de tarjeta</title>
  <style>
    body { font-family: system-ui, Arial; margin: 0; background:#f7f7fb; }
    .card { max-width: 520px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.06); padding: 22px 22px 28px; }
    h1 { font-size: 20px; margin: 0 0 18px; }
    #card-container { border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; }
    button { width: 100%; padding: 12px 14px; border:0; border-radius: 10px; cursor:pointer; margin-top: 16px; font-weight: 600; }
    .primary { background:#4f46e5; color:#fff; }
    .muted { color:#6b7280; font-size: 14px; margin-top:12px;}
    .msg { margin-top: 14px; padding: 10px; border-radius: 8px; font-size: 14px; }
    .ok { background:#ecfdf5; color:#065f46; border:1px solid #34d399; }
    .err{ background:#fef2f2; color:#991b1b; border:1px solid #fca5a5; white-space: pre-wrap;}
  </style>
  <!-- Web Payments SDK (SANDBOX) -->
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
</head>
<body>
  <div class="card">
    <h1>Datos de tarjeta</h1>
    <div id="card-container"></div>
    <button id="pay" class="primary">Continuar</button>
    <div id="out" class="muted"></div>
    <div id="msg" class="msg" style="display:none"></div>
  </div>

  <script>
    // ✅ variables en scope global (evita "card is not defined")
    let payments, card;

    const appId = "sandbox-sq0idb-IsIJtKqx2OHdVJjYmg6puA";            // sandbox app id
    const locationId = "LZVTP0YQ9YQBB";  // sandbox location

    // Monto/currency desde query (?amount=1574&currency=USD&note=...)
    const params = new URLSearchParams(location.search);
    const amount = parseInt(params.get("amount") || "100", 10);
    const currency = (params.get("currency") || "USD").toUpperCase();
    const note = params.get("note") || "Test payment";

    const out = document.getElementById('out');
    const msg = document.getElementById('msg');

    function show(text, ok=false) {
      msg.style.display = 'block';
      msg.className = 'msg ' + (ok ? 'ok' : 'err');
      msg.textContent = text;
    }

    (async function init() {
      try {
        payments = window.Square.payments(appId, locationId); // ✅ inicialización oficial
        card = await payments.card();
        await card.attach('#card-container');
        out.textContent = `Monto: ${amount} ${currency}`;
      } catch (e) {
        show('Error inicializando Square: ' + (e.message || e), false);
      }
    })();

    async function tokenize() {
      const result = await card.tokenize();
      if (result.status === 'OK') return result.token;
      // Muestra detalle de errores del SDK
      const details = (result.errors || []).map(e => `${e.code}: ${e.message}`).join('\n');
      throw new Error(details || 'Tokenization failed');
    }

    document.getElementById('pay').addEventListener('click', async () => {
      msg.style.display = 'none';
      try {
        const nonce = await tokenize();

        // ✅ Llama a tu backend Flask en Render
        const res = await fetch('/api/payments', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            source_id: nonce,
            amount_cents: amount,
            currency: currency,
            note: note
          })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(JSON.stringify(data, null, 2));

        // ✅ Enviar resultado a Flutter y cerrar WebView
        const payment = data.payment;
        const status = payment?.status || 'UNKNOWN';
        const result = {
          status: status,
          success: status === 'COMPLETED',
          payment_id: payment?.id,
          receipt_url: payment?.receipt_url,
          amount: payment?.amount_money?.amount,
          last4: payment?.card_details?.card?.last_4,
          message: status === 'COMPLETED' ? 'Pago procesado exitosamente' : 'Pago fallido'
        };

        // Enviar a Flutter
        if (window.ReactNativeWebView?.postMessage) {
          window.ReactNativeWebView.postMessage(JSON.stringify({type:'payment_result', data: result}));
        } else if (window.webkit?.messageHandlers?.ReactNativeWebView) {
          window.webkit.messageHandlers.ReactNativeWebView.postMessage(JSON.stringify({type:'payment_result', data: result}));
        } else {
          // Fallback - mostrar en WebView
          show(`Pago ${status}\n\nID: ${payment?.id}\nMonto: $${(payment?.amount_money?.amount || 0) / 100}`, status === 'COMPLETED');
        }
      } catch (err) {
        show(String(err), false);
      }
    });
  </script>
</body>
</html>