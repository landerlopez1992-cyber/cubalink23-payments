<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pago Final - ¿Estás seguro?</title>
  <style>
    body { font-family: system-ui, Arial; margin: 0; background:#f7f7fb; }
    .card { max-width: 520px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.06); padding: 22px 22px 28px; }
    h1 { font-size: 20px; margin: 0 0 18px; }
    #card-container { border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; }
    button { width: 100%; padding: 12px 14px; border:0; border-radius: 10px; cursor:pointer; margin-top: 16px; font-weight: 600; }
    .primary { background:#4f46e5; color:#fff; }
    .muted { color:#6b7280; font-size: 14px; margin-top:12px;}
    .msg { margin-top: 14px; padding: 10px; border-radius: 8px; font-size: 14px; }
    .ok { background:#ecfdf5; color:#065f46; border:1px solid #34d399; }
    .err{ background:#fef2f2; color:#991b1b; border:1px solid #fca5a5; white-space: pre-wrap;}
  </style>
  <!-- Web Payments SDK (SANDBOX) -->
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
</head>
<body>
  <div class="card">
    <h1>🔒 Pago Final</h1>
    <p style="color: #6b7280; margin: 0 0 16px;">Confirma tu método de pago seleccionado</p>
    <div id="card-container"></div>
    <button id="pay" class="primary">🔒 Confirmar Pago</button>
    <div id="out" class="muted"></div>
    <div id="msg" class="msg" style="display:none"></div>
  </div>

  <script>
    // ✅ variables en scope global (evita "card is not defined")
    let payments, card;

    const appId = "sandbox-sq0idb-IsIJtKqx2OHdVJjYmg6puA";            // sandbox app id
    const locationId = "LZVTP0YQ9YQBB";  // sandbox location

    // Monto/currency desde query (?amount=1574&currency=USD&note=...)
    const params = new URLSearchParams(location.search);
    const amount = parseInt(params.get("amount") || "100", 10);
    const currency = (params.get("currency") || "USD").toUpperCase();
    const note = params.get("note") || "Test payment";
    
    // ✅ Datos para pre-llenar
    const prefillNumber = params.get("prefill_number");
    const prefillExpiry = params.get("prefill_expiry");
    const prefillCvv = params.get("prefill_cvv");

    const out = document.getElementById('out');
    const msg = document.getElementById('msg');

    function show(text, ok=false) {
      msg.style.display = 'block';
      msg.className = 'msg ' + (ok ? 'ok' : 'err');
      msg.textContent = text;
    }

    (async function init() {
      try {
        payments = window.Square.payments(appId, locationId); // ✅ inicialización oficial
        card = await payments.card();
        await card.attach('#card-container');
        out.textContent = `Monto: ${amount} ${currency}`;
        
        // ✅ Pre-llenar datos si se proporcionan
        if (prefillNumber || prefillExpiry || prefillCvv) {
          console.log('🔄 Intentando pre-llenar:', {number: prefillNumber, expiry: prefillExpiry, cvv: prefillCvv});
          
          // Múltiples intentos con diferentes delays
          const attempts = [500, 1000, 2000, 3000];
          attempts.forEach(delay => {
            setTimeout(() => {
              try {
                // Buscar TODOS los inputs posibles
                const allInputs = document.querySelectorAll('input, iframe');
                console.log('🔍 Inputs encontrados:', allInputs.length);
                
                // Intentar múltiples selectores
                const numberSelectors = [
                  'input[placeholder*="number"]', 'input[placeholder*="Number"]', 'input[placeholder*="NUMBER"]',
                  'input[aria-label*="number"]', 'input[aria-label*="Number"]', 'input[aria-label*="NUMBER"]',
                  'input[name*="card"]', 'input[name*="number"]', 'input[id*="card"]', 'input[id*="number"]',
                  'input[type="text"]', 'input[type="tel"]'
                ];
                
                const expirySelectors = [
                  'input[placeholder*="MM"]', 'input[placeholder*="YY"]', 'input[placeholder*="expir"]',
                  'input[aria-label*="expir"]', 'input[name*="expir"]', 'input[id*="expir"]'
                ];
                
                const cvvSelectors = [
                  'input[placeholder*="CVV"]', 'input[placeholder*="cvv"]', 'input[placeholder*="CVC"]',
                  'input[aria-label*="cvv"]', 'input[name*="cvv"]', 'input[id*="cvv"]'
                ];
                
                // Intentar llenar número
                if (prefillNumber) {
                  for (const selector of numberSelectors) {
                    const field = document.querySelector(selector);
                    if (field && !field.value) {
                      field.value = prefillNumber;
                      field.dispatchEvent(new Event('input', { bubbles: true }));
                      field.dispatchEvent(new Event('change', { bubbles: true }));
                      console.log('✅ Número llenado con selector:', selector);
                      break;
                    }
                  }
                }
                
                // Intentar llenar expiry
                if (prefillExpiry) {
                  for (const selector of expirySelectors) {
                    const field = document.querySelector(selector);
                    if (field && !field.value) {
                      field.value = prefillExpiry;
                      field.dispatchEvent(new Event('input', { bubbles: true }));
                      field.dispatchEvent(new Event('change', { bubbles: true }));
                      console.log('✅ Expiry llenado con selector:', selector);
                      break;
                    }
                  }
                }
                
                // Intentar llenar CVV
                if (prefillCvv) {
                  for (const selector of cvvSelectors) {
                    const field = document.querySelector(selector);
                    if (field && !field.value) {
                      field.value = prefillCvv;
                      field.dispatchEvent(new Event('input', { bubbles: true }));
                      field.dispatchEvent(new Event('change', { bubbles: true }));
                      console.log('✅ CVV llenado con selector:', selector);
                      break;
                    }
                  }
                }
              } catch (e) {
                console.log('⚠️ Error pre-llenando (intento ' + delay + 'ms):', e);
              }
            }, delay);
          });
        }
      } catch (e) {
        show('Error inicializando Square: ' + (e.message || e), false);
      }
    })();

    async function tokenize() {
      const result = await card.tokenize();
      if (result.status === 'OK') return result.token;
      // Muestra detalle de errores del SDK
      const details = (result.errors || []).map(e => `${e.code}: ${e.message}`).join('\n');
      throw new Error(details || 'Tokenization failed');
    }

    document.getElementById('pay').addEventListener('click', async () => {
      msg.style.display = 'none';
      try {
        const nonce = await tokenize();

        // ✅ Llama a tu backend Flask en Render
        const res = await fetch('/api/payments', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            source_id: nonce,
            amount_cents: amount,
            currency: currency,
            note: note
          })
        });

        const data = await res.json();
        
        // ✅ Manejar TANTO éxito como error de Square
        let payment, status, result;
        
        if (res.ok && data.payment) {
          // Pago exitoso
          payment = data.payment;
          status = payment.status || 'COMPLETED';
          result = {
            status: status,
            success: status === 'COMPLETED',
            payment_id: payment.id,
            receipt_url: payment.receipt_url,
            amount: payment.amount_money?.amount,
            last4: payment.card_details?.card?.last_4,
            message: 'Pago procesado exitosamente'
          };
        } else {
          // Error de Square (declined, etc.)
          let errorData = data;
          try {
            // Intentar parsear message si es string JSON
            if (data.message && typeof data.message === 'string') {
              errorData = JSON.parse(data.message);
            }
          } catch (e) {
            // Si no es JSON válido, usar data original
            errorData = data;
          }
          
          payment = errorData.payment;
          status = payment?.status || 'FAILED';
          result = {
            status: 'FAILED',
            success: false,
            payment_id: payment?.id,
            amount: payment?.amount_money?.amount,
            last4: payment?.card_details?.card?.last_4,
            message: data.code === 'GENERIC_DECLINE' ? 'Tarjeta declinada' : 'Pago fallido',
            error_code: data.code
          };
        }

        // ✅ SIEMPRE enviar a Flutter (éxito Y error)
        if (window.ReactNativeWebView?.postMessage) {
          window.ReactNativeWebView.postMessage(JSON.stringify({type:'payment_result', data: result}));
        } else if (window.webkit?.messageHandlers?.ReactNativeWebView) {
          window.webkit.messageHandlers.ReactNativeWebView.postMessage(JSON.stringify({type:'payment_result', data: result}));
        } else {
          // Fallback - mostrar en WebView
          show(`Pago ${status}\n\nID: ${payment?.id || 'N/A'}\nMonto: $${(result.amount || 0) / 100}`, result.success);
        }
      } catch (err) {
        show(String(err), false);
      }
    });
  </script>
</body>
</html>